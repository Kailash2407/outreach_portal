{% extends "base.html" %}

{% block title %}Assemble Outreach Team{% endblock %}

{% block content %}
<style>
    /* Custom styles for this page */
    .form-select option {
        padding: 10px;
        border-bottom: 1px solid #e9ecef;
    }
    
    .form-select option:last-child {
        border-bottom: none;
    }
    
    .form-select option:hover {
        background: linear-gradient(90deg, #EFF6FF 0%, #F8FAFC 100%);
    }
    
    .team-stats {
        background: linear-gradient(135deg, #F8FAFC 0%, #F0F4F8 100%);
        border-radius: 12px;
        padding: 1.5rem;
        border: 2px dashed #cbd5e1;
    }
    
    .stat-card {
        background: white;
        border-radius: 10px;
        padding: 1rem;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        transition: all 0.3s ease;
    }
    
    .stat-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
    
    .form-control, .form-select {
        border-radius: 10px;
        border: 2px solid #e2e8f0;
        padding: 0.875rem 1rem;
        font-size: 0.95rem;
        transition: all 0.2s ease;
    }
    
    .form-control:focus, .form-select:focus {
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }
    
    .card-header-gradient {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 1.5rem;
    }
    
    .pair-selection-card {
        border: 2px solid #e2e8f0;
        border-radius: 12px;
        padding: 1.5rem;
        height: 100%;
        transition: all 0.3s ease;
        background: white;
    }
    
    .pair-selection-card:hover {
        border-color: #3b82f6;
        box-shadow: 0 8px 16px rgba(59, 130, 246, 0.1);
        transform: translateY(-4px);
    }
    
    .badge-circle {
        width: 28px;
        height: 28px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        font-weight: 600;
    }
    
    .assembly-animation {
        animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
        0% { opacity: 0.8; transform: scale(1); }
        50% { opacity: 1; transform: scale(1.05); }
        100% { opacity: 0.8; transform: scale(1); }
    }
    
    .student-avatar {
        width: 32px;
        height: 32px;
        background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 0.875rem;
    }
    
    .team-preview {
        background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
        border-radius: 12px;
        padding: 1.5rem;
        border: 2px dashed #cbd5e1;
        margin-top: 1.5rem;
    }
    
    /* Text color utilities */
    .text-gray-900 { color: #111827 !important; }
    .text-gray-800 { color: #1f2937 !important; }
    .text-gray-700 { color: #374151 !important; }
    .text-gray-600 { color: #4b5563 !important; }
    .text-blue-900 { color: #1e3a8a !important; }
    .text-blue-800 { color: #1e40af !important; }
    .text-blue-700 { color: #1d4ed8 !important; }
    .text-blue-600 { color: #2563eb !important; }
</style>

<main class="container-fluid py-4">
    <!-- Header with Stats - DARK TEXT VERSION -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-0 shadow-lg rounded-4 overflow-hidden" style="background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 50%, #e2e8f0 100%);">
                <div class="card-body p-4 position-relative">
                    <div class="position-absolute top-0 end-0 w-100 h-100" 
                         style="background: radial-gradient(circle at 85% 15%, rgba(37, 99, 235, 0.1) 0%, transparent 60%);">
                    </div>
                    <div class="position-relative d-flex justify-content-between align-items-center">
                        <div>
                            <h1 class="fw-bold mb-2 text-gray-900">Assemble Outreach Team</h1>
                            <p class="mb-0 text-gray-700 fs-5">Combine student pairs into 4-member outreach units</p>
                        </div>
                        <div class="text-end">
                            <div class="fs-2 fw-bold text-gray-900">{{ pairs|length }}</div>
                            <div class="text-gray-600">Available Pairs</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Stats Cards -->
    <div class="row mb-4">
        <div class="col-md-4 mb-3">
            <div class="stat-card">
                <div class="d-flex align-items-center">
                    <div class="rounded-circle bg-primary-subtle p-3 me-3">
                        <i class="bi bi-people-fill text-primary fs-4"></i>
                    </div>
                    <div>
                        <h5 class="fw-bold text-primary mb-1">{{ pairs|length * 2 }}</h5>
                        <p class="text-muted small mb-0">Total Students</p>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4 mb-3">
            <div class="stat-card">
                <div class="d-flex align-items-center">
                    <div class="rounded-circle bg-success-subtle p-3 me-3">
                        <i class="bi bi-person-check-fill text-success fs-4"></i>
                    </div>
                    <div>
                        <h5 class="fw-bold text-success mb-1">{{ pairs|length }}</h5>
                        <p class="text-muted small mb-0">Paired Students</p>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4 mb-3">
            <div class="stat-card">
                <div class="d-flex align-items-center">
                    <div class="rounded-circle bg-warning-subtle p-3 me-3">
                        <i class="bi bi-building-fill text-warning fs-4"></i>
                    </div>
                    <div>
                        <h5 class="fw-bold text-warning mb-1">4</h5>
                        <p class="text-muted small mb-0">Team Size</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Form -->
    <section class="row justify-content-center">
        <article class="col-lg-10">
            <div class="card border-0 shadow-lg rounded-4 overflow-hidden">
                <form method="POST" id="teamForm">
                    <div class="card-body p-4">
                        <!-- Team Name Section -->
                        <div class="mb-5">
                            <label class="form-label fw-bold text-primary d-flex align-items-center gap-2 mb-3">
                                <i class="bi bi-tag-fill"></i>
                                Team Designation <span class="text-danger">*</span>
                            </label>
                            <div class="input-group input-group-lg">
                                <span class="input-group-text bg-light border-end-0">
                                    <i class="bi bi-buildings text-primary"></i>
                                </span>
                                <input type="text" 
                                       name="team_name" 
                                       class="form-control border-start-0 ps-0 shadow-none" 
                                       placeholder="e.g., Outreach Group Alpha" 
                                       required
                                       id="teamNameInput">
                                <span class="input-group-text bg-light">
                                    <span id="charCount">0/50</span>
                                </span>
                            </div>
                            <div class="form-text text-muted small mt-2 d-flex align-items-center gap-2">
                                <i class="bi bi-info-circle"></i>
                                Provide a unique, descriptive name for this four-member outreach unit
                            </div>
                        </div>

                        <!-- Pair Selection Section -->
                        <div class="row g-4 mb-4">
                            <div class="col-md-5">
                                <div class="pair-selection-card border-primary">
                                    <label class="form-label fw-bold text-primary d-flex align-items-center gap-2 mb-3">
                                        <span class="badge-circle bg-primary text-white">1</span>
                                        Primary Pair Selection
                                    </label>
                                    <div class="mb-3">
                                        <select name="pair1_id" class="form-select" required id="pair1Select">
                                            <option value="" disabled selected>Select first pair...</option>
                                            {% for pair in pairs %}
                                                <option value="{{ pair.id }}" 
                                                        data-students='[{"name": "{{ pair.students[0].name }}"}, {"name": "{{ pair.students[1].name }}"}]'>
                                                    Pair #{{ pair.id }}: {{ pair.students[0].name }} & {{ pair.students[1].name }}
                                                </option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    <div id="pair1Preview" class="team-preview" style="display: none;">
                                        <h6 class="fw-semibold text-primary mb-2">Selected Pair Members:</h6>
                                        <div class="d-flex gap-2">
                                            <div class="student-avatar">1</div>
                                            <div class="student-avatar">2</div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="col-md-2 d-flex flex-column align-items-center justify-content-center">
                                <div class="text-primary fs-1 mb-2">
                                    <i class="bi bi-plus-circle-fill assembly-animation"></i>
                                </div>
                                <div class="text-muted small text-center">
                                    Combine to form<br>4-member team
                                </div>
                            </div>

                            <div class="col-md-5">
                                <div class="pair-selection-card border-info">
                                    <label class="form-label fw-bold text-info d-flex align-items-center gap-2 mb-3">
                                        <span class="badge-circle bg-info text-white">2</span>
                                        Secondary Pair Selection
                                    </label>
                                    <div class="mb-3">
                                        <select name="pair2_id" class="form-select" required id="pair2Select">
                                            <option value="" disabled selected>Select second pair...</option>
                                            {% for pair in pairs %}
                                                <option value="{{ pair.id }}"
                                                        data-students='[{"name": "{{ pair.students[0].name }}"}, {"name": "{{ pair.students[1].name }}"}]'>
                                                    Pair #{{ pair.id }}: {{ pair.students[0].name }} & {{ pair.students[1].name }}
                                                </option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    <div id="pair2Preview" class="team-preview" style="display: none;">
                                        <h6 class="fw-semibold text-info mb-2">Selected Pair Members:</h6>
                                        <div class="d-flex gap-2">
                                            <div class="student-avatar">3</div>
                                            <div class="student-avatar">4</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Team Preview -->
                        <div id="teamPreview" class="team-preview" style="display: none;">
                            <h5 class="fw-bold text-primary mb-3 d-flex align-items-center gap-2">
                                <i class="bi bi-eye-fill"></i>
                                Team Preview
                            </h5>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="card border-0 bg-white shadow-sm mb-3">
                                        <div class="card-body">
                                            <h6 class="fw-semibold text-primary mb-2">Team Name:</h6>
                                            <p class="fw-bold fs-5 text-dark" id="previewTeamName">-</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="card border-0 bg-white shadow-sm">
                                        <div class="card-body">
                                            <h6 class="fw-semibold text-primary mb-2">Team Members (4):</h6>
                                            <div class="d-flex flex-wrap gap-2" id="previewMembers">
                                                <!-- Members will be populated here -->
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Form Footer -->
                    <div class="card-footer bg-light p-4 border-top">
                        <div class="row align-items-center">
                            <div class="col-md-7">
                                <div class="d-flex align-items-center gap-3">
                                    <div class="text-primary">
                                        <i class="bi bi-shield-check fs-4"></i>
                                    </div>
                                    <div>
                                        <h6 class="fw-semibold text-dark mb-1">Important Notice</h6>
                                        <p class="text-muted small mb-0">
                                            Once assembled, both pairs will be locked into this team and cannot be modified.
                                            Ensure your selections are correct before proceeding.
                                        </p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-5 text-end">
                                <button type="submit" 
                                        class="btn btn-primary btn-lg px-5 py-3"
                                        id="submitBtn">
                                    <i class="bi bi-check2-all me-2"></i>
                                    <span>Confirm Assembly</span>
                                    <span class="spinner-border spinner-border-sm ms-2 d-none" id="submitSpinner"></span>
                                </button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </article>
    </section>
</main>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const teamNameInput = document.getElementById('teamNameInput');
        const charCount = document.getElementById('charCount');
        const pair1Select = document.getElementById('pair1Select');
        const pair2Select = document.getElementById('pair2Select');
        const pair1Preview = document.getElementById('pair1Preview');
        const pair2Preview = document.getElementById('pair2Preview');
        const teamPreview = document.getElementById('teamPreview');
        const previewTeamName = document.getElementById('previewTeamName');
        const previewMembers = document.getElementById('previewMembers');
        const teamForm = document.getElementById('teamForm');
        const submitBtn = document.getElementById('submitBtn');
        const submitSpinner = document.getElementById('submitSpinner');

        // Character counter for team name
        teamNameInput.addEventListener('input', function() {
            const length = this.value.length;
            charCount.textContent = `${length}/50`;
            
            if (length > 45) {
                charCount.classList.add('text-warning');
            } else {
                charCount.classList.remove('text-warning');
            }
            
            updateTeamPreview();
        });

        // Pair selection handlers
        function handlePairSelection(select, previewId) {
            const selectedOption = select.options[select.selectedIndex];
            if (selectedOption.value) {
                const students = JSON.parse(selectedOption.getAttribute('data-students') || '[]');
                const preview = document.getElementById(previewId);
                
                if (previewId === 'pair1Preview') {
                    const avatars = preview.querySelectorAll('.student-avatar');
                    students.forEach((student, index) => {
                        if (avatars[index]) {
                            avatars[index].textContent = student.name.charAt(0).toUpperCase();
                        }
                    });
                }
                
                preview.style.display = 'block';
                updateTeamPreview();
            } else {
                document.getElementById(previewId).style.display = 'none';
                updateTeamPreview();
            }
        }

        pair1Select.addEventListener('change', function() {
            handlePairSelection(this, 'pair1Preview');
            // Disable the selected option in the other select
            if (this.value) {
                Array.from(pair2Select.options).forEach(option => {
                    option.disabled = option.value === this.value;
                });
            }
        });

        pair2Select.addEventListener('change', function() {
            handlePairSelection(this, 'pair2Preview');
            // Disable the selected option in the other select
            if (this.value) {
                Array.from(pair1Select.options).forEach(option => {
                    option.disabled = option.value === this.value;
                });
            }
        });

        // Update team preview
        function updateTeamPreview() {
            const teamName = teamNameInput.value.trim();
            const pair1Selected = pair1Select.value;
            const pair2Selected = pair2Select.value;
            
            if (teamName || pair1Selected || pair2Selected) {
                teamPreview.style.display = 'block';
                
                // Update team name
                previewTeamName.textContent = teamName || '-';
                
                // Update members
                previewMembers.innerHTML = '';
                
                // Get members from both pairs
                let allMembers = [];
                
                if (pair1Selected) {
                    const students1 = JSON.parse(pair1Select.options[pair1Select.selectedIndex].getAttribute('data-students') || '[]');
                    allMembers = allMembers.concat(students1);
                }
                
                if (pair2Selected) {
                    const students2 = JSON.parse(pair2Select.options[pair2Select.selectedIndex].getAttribute('data-students') || '[]');
                    allMembers = allMembers.concat(students2);
                }
                
                // Display members
                allMembers.forEach((member, index) => {
                    const memberBadge = document.createElement('div');
                    memberBadge.className = 'd-flex align-items-center gap-2 bg-light rounded-pill px-3 py-2';
                    memberBadge.innerHTML = `
                        <div class="student-avatar">${index + 1}</div>
                        <span class="fw-medium">${member.name}</span>
                    `;
                    previewMembers.appendChild(memberBadge);
                });
                
                // Update submit button state
                submitBtn.disabled = !(teamName && pair1Selected && pair2Selected);
            } else {
                teamPreview.style.display = 'none';
                submitBtn.disabled = true;
            }
        }

        // Form submission handler
        teamForm.addEventListener('submit', function(e) {
            if (pair1Select.value === pair2Select.value) {
                e.preventDefault();
                alert('Error: You cannot select the same pair twice.');
                return;
            }
            
            // Show loading spinner
            submitBtn.disabled = true;
            submitSpinner.classList.remove('d-none');
            submitBtn.innerHTML = `
                <i class="bi bi-check2-all me-2"></i>
                <span>Assembling Team...</span>
                <span class="spinner-border spinner-border-sm ms-2"></span>
            `;
            
            // Add slight delay to show the spinner
            setTimeout(() => {
                this.submit();
            }, 100);
        });

        // Initialize
        updateTeamPreview();
        
        // Add animation to cards on load
        document.querySelectorAll('.pair-selection-card').forEach((card, index) => {
            card.style.animationDelay = `${index * 0.2}s`;
            card.classList.add('animate__animated', 'animate__fadeInUp');
        });
    });
</script>
{% endblock %}
{% extends "base.html" %}

{% block title %}Student Directory | Outreach Portal{% endblock %}

{% block content %}
<main class="container-fluid py-4">
    <header class="row mb-4 align-items-center">
        <div class="col-md-6">
            <h1 class="fw-bold text-primary">Student Directory</h1>
            <p class="text-muted">Manage participant accounts and monitor pairing progress.</p>
        </div>
        <div class="col-md-6 text-md-end">
            <a href="{{ url_for('admin.enroll_student') }}" class="btn btn-primary px-4">
                <i class="bi bi-person-plus-fill me-2"></i>Enroll Participant
            </a>
        </div>
    </header>

    <!-- Stats Cards -->
    <div class="row mb-4">
        <div class="col-md-4 mb-3 mb-md-0">
            <div class="card border-0 shadow-sm rounded-4 h-100">
                <div class="card-body d-flex align-items-center">
                    <div class="rounded-circle bg-primary-subtle p-3 me-3">
                        <i class="bi bi-people-fill text-primary fs-4"></i>
                    </div>
                    <div>
                        <h5 class="fw-bold text-primary mb-1">{{ students|length }}</h5>
                        <p class="text-muted small mb-0">Total Students</p>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4 mb-3 mb-md-0">
            <div class="card border-0 shadow-sm rounded-4 h-100">
                <div class="card-body d-flex align-items-center">
                    <div class="rounded-circle bg-success-subtle p-3 me-3">
                        <i class="bi bi-person-check text-success fs-4"></i>
                    </div>
                    <div>
                        <h5 class="fw-bold text-success mb-1">{{ students|selectattr('pair_id')|list|length }}</h5>
                        <p class="text-muted small mb-0">Paired</p>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card border-0 shadow-sm rounded-4 h-100">
                <div class="card-body d-flex align-items-center">
                    <div class="rounded-circle bg-warning-subtle p-3 me-3">
                        <i class="bi bi-person-x text-warning fs-4"></i>
                    </div>
                    <div>
                        <h5 class="fw-bold text-warning mb-1">{{ students|rejectattr('pair_id')|list|length }}</h5>
                        <p class="text-muted small mb-0">Unpaired</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <section class="card border-0 shadow-sm rounded-4 mb-4">
        <div class="card-body p-3">
            <div class="input-group">
                <span class="input-group-text bg-transparent border-end-0 text-muted">
                    <i class="bi bi-search"></i>
                </span>
                <input type="text" id="directorySearch" class="form-control border-start-0 ps-0 shadow-none" 
                       placeholder="Search by student name or username (e.g. 'John' or '@jdoe')...">
            </div>
        </div>
    </section>

    <section class="card border-0 shadow-sm rounded-4">
        <div class="table-responsive">
            <table class="table table-hover align-middle mb-0" id="studentTable">
                <thead class="bg-light">
                    <tr>
                        <th class="ps-4 py-3 text-uppercase small fw-bold text-primary">Full Name</th>
                        <th class="py-3 text-uppercase small fw-bold text-primary">Username</th>
                        <th class="py-3 text-uppercase small fw-bold text-primary">Status</th>
                        <th class="py-3 text-uppercase small fw-bold text-primary">Team Assignment</th>
                        <th class="py-3 text-center text-uppercase small fw-bold text-primary" style="width: 100px;">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for student in students %}
                    {# FIXED: Using correct relationship names from models.py #}
                    {% set in_team = student.pair and student.pair.team_id %}
                    <tr>
                        <td class="ps-4">
                            <div class="fw-semibold text-dark name-field">{{ student.name }}</div>
                            <div class="text-muted small mt-1">
                                {{ student.dept }} • {{ student.register_number }}
                                {% if student.section %}
                                • Section {{ student.section }}
                                {% endif %}
                            </div>
                        </td>
                        <td><code class="text-primary fw-medium user-field">@{{ student.username }}</code></td>
                        <td>
                            {% if student.pair_id %}
                                <span class="badge rounded-pill bg-success-subtle text-success border border-success-subtle px-3 py-2">
                                    <i class="bi bi-check-circle-fill me-1"></i> Paired
                                </span>
                            {% else %}
                                <span class="badge rounded-pill bg-warning-subtle text-warning border border-warning-subtle px-3 py-2">
                                    <i class="bi bi-clock-history me-1"></i> Unpaired
                                </span>
                            {% endif %}
                        </td>
                        <td>
                            {% if in_team %}
                                <div class="text-dark small fw-bold">
                                    <i class="bi bi-shield-lock-fill text-primary me-1"></i> 
                                    {{ student.pair.team.team_name }}
                                </div>
                            {% else %}
                                <span class="text-muted small italic">No Team Assigned</span>
                            {% endif %}
                        </td>
                        <td class="text-center">
                            <div class="dropdown">
                                <button class="btn btn-sm btn-outline-secondary border-0 rounded-circle action-btn" 
                                        type="button" data-bs-toggle="dropdown" data-bs-boundary="viewport" aria-expanded="false">
                                    <i class="bi bi-three-dots-vertical"></i>
                                </button>
                                <ul class="dropdown-menu dropdown-menu-end shadow border-0 py-2">
                                    <li><h6 class="dropdown-header text-uppercase small fw-bold text-muted">Management</h6></li>
                                    
                                    <li>
                                        <a class="dropdown-item py-2" href="{{ url_for('admin.reset_password', user_id=student.id) }}">
                                            <i class="bi bi-key me-2 text-primary"></i>Reset Password
                                        </a>
                                    </li>

                                    <li>
                                        {% if in_team %}
                                            <span class="dropdown-item py-2 text-muted opacity-50 cursor-lock" title="Disband team first">
                                                <i class="bi bi-lock-fill me-2"></i>Unpair (Locked)
                                            </span>
                                        {% elif student.pair_id %}
                                            <a class="dropdown-item py-2" href="{{ url_for('admin.unpair_student', user_id=student.id) }}"
                                               onclick="return confirm('Dissolve pairing for {{ student.name }}?')">
                                                <i class="bi bi-person-x me-2 text-warning"></i>Unpair Student
                                            </a>
                                        {% endif %}
                                    </li>

                                    <li><hr class="dropdown-divider opacity-50"></li>

                                    <li>
                                        {% if student.pair_id %}
                                            <span class="dropdown-item py-2 text-muted opacity-50 cursor-lock" title="Unpair student before deleting">
                                                <i class="bi bi-trash3 me-2"></i>Delete (Locked)
                                            </span>
                                        {% else %}
                                            <a class="dropdown-item py-2 text-danger" href="{{ url_for('admin.delete_student', user_id=student.id) }}"
                                               onclick="return confirm('Permanently delete {{ student.name }}?')">
                                                <i class="bi bi-trash3 me-2"></i>Delete User
                                            </a>
                                        {% endif %}
                                    </li>
                                </ul>
                            </div>
                        </td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</section>

<script>
    // Live Search Logic
    document.getElementById('directorySearch').addEventListener('keyup', function() {
        const filter = this.value.toLowerCase();
        const rows = document.querySelectorAll('#studentTable tbody tr');
    
        rows.forEach(row => {
            const name = row.querySelector('.name-field').textContent.toLowerCase();
            const username = row.querySelector('.user-field').textContent.toLowerCase();
        
            if (name.includes(filter) || username.includes(filter)) {
                row.style.display = "";
            } else {
                row.style.display = "none";
            }
        });
    });
</script>

<style>
    .table-responsive { overflow: visible !important; }
    .dropdown-menu { z-index: 1060; min-width: 190px; }
    .cursor-lock { cursor: not-allowed; }
    .bg-success-subtle { background-color: #ecfdf5 !important; color: #065f46 !important; }
    .bg-warning-subtle { background-color: #fffbeb !important; color: #92400e !important; }
    .bg-primary-subtle { background-color: #eff6ff !important; }
    #directorySearch::placeholder { color: #94a3b8; font-size: 0.9rem; }
    
    /* Stats cards styling */
    .card-body .rounded-circle {
        width: 60px;
        height: 60px;
        display: flex;
        align-items: center;
        justify-content: center;
    }
</style>
{% endblock %}